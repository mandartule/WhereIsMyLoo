<% layout('layouts/boilerplate') %>
  <!-- Load show page CSS -->
  <link rel="stylesheet" href="/css/show.css">

  <div class="show-container">
    <!-- Page Header -->
    <div class="show-header">
      <h1 class="show-title">üöª <%= toilet.title %>
      </h1>
      <p class="show-location">
        <i class="bi bi-geo-alt"></i>
        <%= toilet.location %>
      </p>
    </div>

    <!-- Main Content Grid -->
    <div class="show-content">
      <!-- Left Column: Details -->
      <div class="details-card">
        <!-- Image Carousel -->
        <div class="image-carousel">
          <% if (toilet.images && toilet.images.length> 0) { %>
            <div id="toiletImagesCarousel" class="carousel slide" data-bs-ride="carousel">
              <div class="carousel-inner">
                <% toilet.images.forEach(function(image, idx) { %>
                  <div class="carousel-item <%= idx === 0 ? 'active' : '' %>">
                    <img src="<%= image.url %>" class="carousel-image" alt="Toilet image <%= idx + 1 %>">
                  </div>
                  <% }); %>
              </div>
              <% if (toilet.images.length> 1) { %>
                <button class="carousel-control-prev" type="button" data-bs-target="#toiletImagesCarousel"
                  data-bs-slide="prev">
                  <span class="carousel-control-prev-icon"></span>
                </button>
                <button class="carousel-control-next" type="button" data-bs-target="#toiletImagesCarousel"
                  data-bs-slide="next">
                  <span class="carousel-control-next-icon"></span>
                </button>
                <% } %>
            </div>
            <% } else { %>
              <div class="carousel-image"
                style="display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #f3f4f6, #e5e7eb);">
                <div class="text-center">
                  <i class="bi bi-image" style="font-size: 3rem; color: var(--text-muted);"></i>
                  <p style="color: var(--text-muted); margin-top: 1rem;">No images available</p>
                </div>
              </div>
              <% } %>
        </div>

        <!-- Details Content -->
        <div class="details-content">
          <!-- Description -->
          <div class="detail-item">
            <div class="detail-icon">üìù</div>
            <div class="detail-content">
              <div class="detail-label">Description</div>
              <div class="detail-value">
                <%= toilet.description || 'No description provided' %>
              </div>
            </div>
          </div>

          <!-- Price -->
          <div class="detail-item">
            <div class="detail-icon">üí∞</div>
            <div class="detail-content">
              <div class="detail-label">Price</div>
              <div class="detail-value">
                <%= toilet.isPaid ? `‚Çπ${toilet.price}` : 'Free' %>
              </div>
            </div>
          </div>

          <!-- Gender Access -->
          <div class="detail-item">
            <div class="detail-icon">üöπüö∫</div>
            <div class="detail-content">
              <div class="detail-label">Gender Access</div>
              <div class="detail-value">
                <%= toilet.genderAccess %>
              </div>
            </div>
          </div>

          <!-- Accessibility -->
          <div class="detail-item">
            <div class="detail-icon">‚ôø</div>
            <div class="detail-content">
              <div class="detail-label">Wheelchair Accessible</div>
              <div class="detail-value">
                <%= toilet.isAccessible ? 'Yes' : 'No' %>
              </div>
            </div>
          </div>

          <!-- Sanitary Facilities -->
          <div class="detail-item">
            <div class="detail-icon">ü©∏</div>
            <div class="detail-content">
              <div class="detail-label">Sanitary Pad Disposal</div>
              <div class="detail-value">
                <%= toilet.hasSanitaryPadDisposal ? 'Available' : 'Not Available' %>
              </div>
            </div>
          </div>

          <!-- Cleanliness Rating -->
          <div class="detail-item">
            <div class="detail-icon">‚ú®</div>
            <div class="detail-content">
              <div class="detail-label">Cleanliness Rating</div>
              <div class="detail-value">
                <% if (toilet.cleanlinessRating) { %>
                  <%= '‚≠ê' .repeat(toilet.cleanlinessRating) %> (<%= toilet.cleanlinessRating %>/5)
                      <% } else { %>
                        Not rated yet
                        <% } %>
              </div>
            </div>
          </div>

          <!-- Feature Tags -->
          <div class="feature-tags">
            <span class="feature-tag <%= toilet.isPaid ? 'paid' : 'free' %>">
              <%= toilet.isPaid ? `‚Çπ${toilet.price}` : 'Free' %>
            </span>
            <span class="feature-tag">
              <%= toilet.genderAccess %>
            </span>
            <% if (toilet.isAccessible) { %>
              <span class="feature-tag accessible">‚ôø Accessible</span>
              <% } %>
          </div>

          <!-- Added By -->
          <p style="color: var(--text-muted); font-size: 0.9rem; text-align: center; margin-top: 1rem;">
            Added by: <%= toilet.author && toilet.author.username ? toilet.author.username : 'Unknown' %>
          </p>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
          <a href="/toilets" class="action-btn btn-back">
            <i class="bi bi-arrow-left"></i> Back to List
          </a>
          <% if (currentUser && toilet.author && toilet.author.equals(currentUser._id)) { %>
            <a href="/toilets/<%= toilet._id %>/edit" class="action-btn btn-edit">
              <i class="bi bi-pencil"></i> Edit
            </a>
            <form action="/toilets/<%= toilet._id %>?_method=DELETE" method="POST" style="display: inline;">
              <button type="submit" class="action-btn btn-delete"
                onclick="return confirm('Are you sure you want to delete this toilet?')">
                <i class="bi bi-trash"></i> Delete
              </button>
            </form>
            <% } %>
        </div>
      </div>

      <!-- Right Column: Map & Reviews -->
      <div class="map-reviews-section">

        <!-- Map Container -->
        <div class="map-container">
          <div id="map" style="height: 100%; width: 100%;"></div>
        </div>

        <!-- Reviews Section -->
        <div class="reviews-container">
          <div class="reviews-header">
            <h3 class="reviews-title">üí¨ Reviews</h3>
            <% if (toilet.reviewCount && toilet.reviewCount> 0) { %>
              <span class="reviews-count">
                <%= toilet.reviewCount %>
              </span>
              <% } %>
          </div>

          <!-- Average Rating -->
          <% if (toilet.averageRating && toilet.averageRating> 0) { %>
            <div
              style="text-align: center; margin-bottom: 2rem; padding: 1rem; background: var(--background); border-radius: 12px;">
              <div style="font-size: 2rem; margin-bottom: 0.5rem;">
                <%= '‚≠ê' .repeat(Math.floor(toilet.averageRating)) %>
              </div>
              <div style="font-weight: 600; color: var(--text-primary);">
                <%= toilet.averageRating %>/5 Average Rating
              </div>
            </div>
            <% } %>

              <!-- Add Review Form -->
              <% if (currentUser) { %>
                <% let userReview=toilet.reviews && toilet.reviews.find(r=> r.author && r.author.equals &&
                  r.author.equals(currentUser._id)) %>
                  <% if (!userReview) { %>
                    <div class="review-form">
                      <h4 style="margin-bottom: 1rem;">Add Your Review</h4>
                      <form action="/toilets/<%= toilet._id %>/reviews" method="POST">
                        <div style="margin-bottom: 1rem;">
                          <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">Rating</label>
                          <select class="form-select" name="review[rating]" required>
                            <option value="">Select Rating</option>
                            <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (5 - Excellent)</option>
                            <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê (4 - Good)</option>
                            <option value="3">‚≠ê‚≠ê‚≠ê (3 - Average)</option>
                            <option value="2">‚≠ê‚≠ê (2 - Poor)</option>
                            <option value="1">‚≠ê (1 - Terrible)</option>
                          </select>
                        </div>
                        <div style="margin-bottom: 1rem;">
                          <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">Review</label>
                          <textarea class="form-control" name="review[body]" rows="3"
                            placeholder="Share your experience..." required></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">Submit Review</button>
                      </form>
                    </div>
                    <% } else { %>
                      <p
                        style="color: var(--toilet-clean); font-weight: 600; text-align: center; padding: 1rem; background: rgba(16, 185, 129, 0.1); border-radius: 12px;">
                        ‚úÖ You have already reviewed this toilet
                      </p>
                      <% } %>
                        <% } else { %>
                          <p
                            style="text-align: center; padding: 1rem; background: var(--background); border-radius: 12px;">
                            <a href="/login" style="color: var(--primary-blue); font-weight: 600;">Login</a> to add a
                            review
                          </p>
                          <% } %>

                            <!-- Display Reviews -->
                            <div style="margin-top: 2rem;">
                              <% if (toilet.reviews && toilet.reviews.length> 0) { %>
                                <% for (let review of toilet.reviews) { %>
                                  <div class="review-item">
                                    <div class="review-header">
                                      <div>
                                        <div class="review-author">
                                          <%= review.author && review.author.username ? review.author.username
                                            : 'Anonymous' %>
                                        </div>
                                        <div class="review-rating">
                                          <%= '‚≠ê' .repeat(review.rating) %> (<%= review.rating %>/5)
                                        </div>
                                      </div>
                                      <% if (currentUser && review.author && review.author.equals &&
                                        review.author.equals(currentUser._id)) { %>
                                        <form
                                          action="/toilets/<%= toilet._id %>/reviews/<%= review._id %>?_method=DELETE"
                                          method="POST" style="display: inline;">
                                          <button type="submit" class="btn btn-sm btn-outline-danger"
                                            onclick="return confirm('Delete this review?')">
                                            <i class="bi bi-trash"></i>
                                          </button>
                                        </form>
                                        <% } %>
                                    </div>
                                    <p class="review-text">
                                      <%= review.body %>
                                    </p>
                                    <div class="review-date">
                                      <%= review.datePosted ? new Date(review.datePosted).toLocaleDateString()
                                        : 'Unknown date' %>
                                    </div>
                                  </div>
                                  <% } %>
                                    <% } else { %>
                                      <p style="text-align: center; color: var(--text-muted); padding: 2rem;">
                                        No reviews yet. Be the first to review! üåü
                                      </p>
                                      <% } %>
                            </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Mapbox CSS and JS -->
<link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />
<script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>

<script>
  mapboxgl.accessToken = '<%= process.env.MAPBOX_TOKEN %>';
  
  const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/streets-v12',
    center: [<%= toilet.geometry.coordinates[0] %>, <%= toilet.geometry.coordinates[1] %>],
    zoom: 15
  });

  // Add marker for toilet location
  const marker = new mapboxgl.Marker({ 
    color: '#2563eb', 
    scale: 1.2 
  })
  .setLngLat([<%= toilet.geometry.coordinates[0] %>, <%= toilet.geometry.coordinates[1] %>])
  .setPopup(
    new mapboxgl.Popup({ offset: 25 })
    .setHTML(`
      <div style="padding: 0.5rem;">
        <h6 style="margin: 0 0 0.5rem 0; color: #111827;">üöª <%= toilet.title %></h6>
        <p style="margin: 0; color: #6b7280; font-size: 0.85rem;"><%= toilet.location %></p>
      </div>
    `)
  )
  .addTo(map);

  // Add navigation controls
  map.addControl(new mapboxgl.NavigationControl());
  
  // Add fullscreen control
  map.addControl(new mapboxgl.FullscreenControl());
</script>